version: "3.8"

# Mizuchi Uploadr Full-Feature Development Environment
#
# Usage:
#   MinIO only (testing): docker-compose up -d
#   Full environment:     docker-compose --profile full up -d
#   With monitoring:      docker-compose --profile full --profile monitoring up -d
#
# The default profile starts only MinIO, allowing you to test the uploader CLI
# directly against the S3-compatible API without building the mizuchi server.

services:
  # MinIO - S3-compatible object storage (always starts)
  minio:
    image: minio/minio:RELEASE.2024-05-10T01-41-38Z
    container_name: mizuchi-minio
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Web Console
    environment:
      # WARNING: Change credentials in production!
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      # Use curl instead of mc (mc is not included in minio server image)
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Create default bucket on startup (always runs)
  minio-init:
    image: minio/mc:RELEASE.2024-05-09T17-04-24Z
    container_name: mizuchi-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin123;
      mc mb myminio/uploads --ignore-existing;
      mc mb myminio/private --ignore-existing;
      mc anonymous set upload myminio/uploads;
      echo 'Buckets created successfully';
      exit 0;
      "

  # Mizuchi Uploadr - S3 Upload Proxy
  # Use profile "full" to include, or skip with --profile minio-only
  mizuchi:
    image: ghcr.io/julianshen/mizuchi-uploadr:latest
    container_name: mizuchi-uploadr
    profiles:
      - full            # Only start in full mode
    build:
      context: ..
      dockerfile: Dockerfile
    ports:
      - "8080:8080"   # Main API
      - "9090:9090"   # Metrics
    environment:
      # S3 Backend Configuration
      AWS_ACCESS_KEY: minioadmin
      AWS_SECRET_KEY: minioadmin123
      # JWT Authentication
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
      # Logging
      RUST_LOG: info
    volumes:
      - ./config.yaml:/app/config.yaml:ro
    depends_on:
      minio-init:
        condition: service_completed_successfully
    command: ["--config", "/app/config.yaml"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # Prometheus (optional - for metrics collection)
  prometheus:
    image: prom/prometheus:v2.51.2
    container_name: mizuchi-prometheus
    profiles:
      - monitoring
    ports:
      - "9091:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    depends_on:
      - mizuchi

  # Grafana (optional - for metrics visualization)
  grafana:
    image: grafana/grafana:10.4.2
    container_name: mizuchi-grafana
    profiles:
      - monitoring
    ports:
      - "3000:3000"
    environment:
      # WARNING: Change credentials in production!
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus

volumes:
  minio_data:
  prometheus_data:
  grafana_data:

networks:
  default:
    name: mizuchi-network
